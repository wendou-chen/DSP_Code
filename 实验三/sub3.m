%% FIR 内容: 设计与应用
clear; clc; close all;

% --- (1) 凯塞窗 (Kaiser) 低通设计示例 ---
wp_pi = 0.3; ws_pi = 0.5; As = 50;
dw = ws_pi - wp_pi;      % 过渡带宽度 /pi
omega_c = (wp_pi + ws_pi)/2; 
% 计算阶数 M (指导书用N表示) 和 beta
M = ceil((As - 8) / (2.285 * dw * pi)); % 估算公式
beta = 0.1102 * (As - 8.7);
win = kaiser(M+1, beta); % 窗长度为 M+1
hn = fir1(M, omega_c, win);
figure(1); freqz(hn, 1); title('Kaiser Window FIR');

% --- (2) FIR 应用 (利用 fdatool 生成的系数进行滤波) ---
% 信号生成 (同 IIR 实验)
f1 = 0.08; f2 = 0.2; f3 = 0.36; Fs = 1; N = 1500;
n = 0 : N-1;
xn = sin(2*pi*f1*n) + sin(2*pi*f2*n) - cos(2*pi*f3*n);

% --- 这里的 B 对应实验指导书 P16 的截图内容 ---
B_coeffs = [ ...
    0.002494178517912, 0.0006805543241302, -0.003870283836164, -0.008165619507879, ...
    -0.007330172880412, 0.00129585175512,   0.01413105008236,   0.02142970494199, ...
     0.01323933002194, -0.01165544117543,  -0.04031755283788,  -0.0494259832874, ...
    -0.01815518553849,  0.05691830045762,   0.1549724986511,    0.2382835156828, ...
     0.2709505092575,   0.2382835156828,    0.1549724986511,    0.05691830045762, ...
    -0.01815518553849, -0.0494259832874,   -0.04031755283788,  -0.01165544117543, ...
     0.01323933002194,  0.02142970494199,   0.01413105008236, ...
     0.00129585175512, -0.007330172880412, -0.008165619507879, -0.003870283836164, ...
     0.0006805543241302, 0.002494178517912 ];

% 执行 FIR 滤波
yn = filter(B_coeffs, 1, xn);

% --- 绘制时域波形 ---
figure('Name', 'FIR 应用结果');
subplot(2,2,1); plot(n, xn); title('原始信号 x(n)'); axis([0 200 -3 3]); grid on;
subplot(2,2,3); plot(n, yn); title('FIR滤波后信号 y(n)'); axis([0 200 -3 3]); grid on;

% --- 绘制频谱对比 (自行编写代码部分) ---
% 频谱计算函数 (简单封装)
[f_axis, mag_x] = get_spectrum(xn, Fs);
[~,      mag_y] = get_spectrum(yn, Fs);

subplot(2,2,2); plot(f_axis, mag_x); title('原始信号频谱'); xlabel('Hz'); grid on;
subplot(2,2,4); plot(f_axis, mag_y); title('FIR滤波后频谱'); xlabel('Hz'); grid on;

% ---------------------------
% 辅助函数：计算单边谱
function [f, mag] = get_spectrum(signal, Fs)
    L = length(signal);
    Y = fft(signal);
    P2 = abs(Y/L);
    mag = P2(1:L/2+1);
    mag(2:end-1) = 2*mag(2:end-1);
    f = Fs*(0:(L/2))/L;
end